<!-- =========================
     index.html（完全版）
     ========================= -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>IdentityV 参加型メンバー自動調整</title>
  <meta name="description" content="第5人格の参加型配信用：サバ4＋ハン1の自動抽選＆平均化。新規優先・手動修正・削除/一括削除・2試合同時・主催者固定・OBSオーバーレイ・通知（iOSはPWA）対応。">

  <!-- PWA/通知 -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2563eb">

  <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
  <header class="row" style="justify-content:space-between;align-items:flex-start">
    <div>
      <h1>IdentityV 参加型メンバー自動調整</h1>
      <p class="muted">
        サバ4＋ハン1を<b>総出場回数が平均</b>になるよう自動抽選。新規参加者は初回まで優先。<br>
        手動修正（回数±・名前/希望編集・手動試合登録）、削除・一括削除、<b>2試合同時</b>（アクティブ10人以上）、主催者固定、ハンターのみローテ表示に対応。
      </p>
    </div>
    <div style="text-align:right">
      <div class="row" style="justify-content:flex-end">
        <button id="themeBtnTop" class="btn theme-btn" onclick="cycleTheme()" aria-label="テーマ切替">🌓 Auto</button>
        <button class="btn" onclick="openOverlay()">配信用オーバーレイ</button>
        <button id="notifyBtn" class="btn" onclick="enableLineupNotifications()">通知を有効化</button>
        <button id="iosGuideBtn" class="btn" style="display:none" onclick="openIOSGuide()">iOSで通知を使う</button>
      </div>
      <div class="theme-label" id="themeLabelTop" aria-hidden="true">OS設定に追従</div>
    </div>
  </header>

  <section class="card">
    <div class="row">
      <input id="nameInput" type="text" placeholder="プレイヤー名" style="min-width:220px;flex:1" inputmode="text" autocomplete="off">
      <select id="prefInput" title="ロール希望" aria-label="ロール希望">
        <option value="either">希望なし</option>
        <option value="survivor">サバイバー希望</option>
        <option value="hunter">ハンター希望</option>
        <option value="survivor-only">サバイバーのみ</option>
        <option value="hunter-only">ハンターのみ</option>
      </select>
      <button class="btn btn-primary" onclick="addPlayer()">追加</button>
      <button class="btn" onclick="exportCSV()">CSVエクスポート</button>
      <label class="row" style="gap:6px" title="オンで手動修正UIを表示">
        <input id="manualToggle" type="checkbox" onchange="toggleManual()"><span>手動修正</span>
      </label>
    </div>
    <p class="muted" style="margin:6px 0 0">手動の回数±は「調整値」として保存され、履歴からの再計算と合算されます。</p>
  </section>

  <section class="grid grid-2" style="margin-top:10px">
    <div class="card">
      <h3>次の試合</h3>
      <div class="row">
        <button id="btnAutoPick" class="btn btn-primary" onclick="pickNext()">自動選定（確定）</button>
        <button class="btn" onclick="undoLastMatch()">直前の試合を取り消し</button>
      </div>
      <div class="row" style="margin-top:8px">
        <label class="row" style="gap:6px" title="アクティブ10人以上で有効">
          <input id="dualToggle" type="checkbox" onchange="toggleDual()">
          <span>2試合同時</span>
        </label>
        <span id="dualHint" class="muted"></span>
      </div>

      <!-- 主催者固定モード -->
      <div class="row" style="margin-top:8px">
        <label class="row" style="gap:6px" title="主催者を毎試合必ず参加させます">
          <input id="hostModeToggle" type="checkbox" onchange="toggleHostMode()">
          <span>主催者を必ず参加させる</span>
        </label>
        <select id="hostSelect" style="min-width:180px" onchange="setHost(this.value)"></select>
      </div>
      <p class="muted" style="margin:8px 0 0">
        主催者固定 ON 時は、主催者がアクティブにいる場合、その人を毎回の試合メンバーに必ず含めます。<br>
        2試合同時の場合は A 側の試合に含めます。
      </p>

      <!-- ハンターのみローテ表示（別枠） -->
      <div class="card" style="margin-top:12px; box-shadow:none;">
        <div class="row space-between" style="align-items:baseline">
          <h3 style="margin:0">ハンターのみ ローテーション</h3>
          <span class="muted" style="font-size:12px">（登録順 / アクティブのみ）</span>
        </div>
        <div id="hunterOnlyQueue" class="last" style="margin-top:8px">—</div>
        <p class="muted" style="margin:8px 0 0">
          ※ ハンターのみが複数いる場合、ハンター役は<b>登録順でローテーション</b>します。<br>
          ※ ただしサバイバー不足（必要人数に満たない）時は、ハンターのみもサバに割り当てられる場合があります。
        </p>
      </div>
    </div>

    <div class="card">
      <h3>直近の試合</h3>
      <div id="lastWrap" class="two-col">
        <div id="lastMatchA" class="last">まだ試合はありません</div>
        <div id="lastMatchB" class="last" style="display:none">—</div>
      </div>
    </div>
  </section>

  <section class="card" style="margin-top:10px">
    <div class="row" style="justify-content:space-between;align-items:baseline">
      <h3>参加者一覧</h3>
      <div class="row toolbar">
        <label class="row" style="gap:6px">
          <input id="masterSelect" type="checkbox" onchange="toggleSelectAll(this.checked)">
          <span>全選択</span>
        </label>
        <button class="btn" onclick="selectRecentAdded()">このセッションで追加を選択</button>
        <button class="btn btn-danger" onclick="bulkDeleteSelected()">選択を一括削除</button>
        <span class="muted">選択中: <span id="selCount">0</span>｜<span id="stats"></span></span>
      </div>
    </div>
    <div class="table-wrap" style="margin-top:6px">
      <table>
        <thead>
          <tr>
            <th>選</th><th>名前（✓=アクティブ）</th><th class="num">サバ</th><th class="num">ハン</th><th class="num">合計</th><th>希望</th><th>操作</th>
          </tr>
        </thead>
        <tbody id="playerTbody"></tbody>
      </table>
    </div>
  </section>

  <section id="manualPanel" class="card" style="margin-top:10px;display:none">
    <h3>手動で試合を登録</h3>
    <div class="row" style="align-items:flex-end">
      <div>
        <label class="muted">ハンター</label><br>
        <select id="manualHunter" style="min-width:180px"></select>
      </div>
      <div>
        <label class="muted">サバイバー（4人）</label><br>
        <select id="manualS1" style="min-width:140px"></select>
        <select id="manualS2" style="min-width:140px"></select>
        <select id="manualS3" style="min-width:140px"></select>
        <select id="manualS4" style="min-width:140px"></select>
      </div>
      <button class="btn btn-primary" onclick="addManualMatch()">試合を追加</button>
      <span class="muted">※ 同一人物は選べません。追加後に再集計。</span>
    </div>
  </section>

  <section class="card" style="margin-top:10px">
    <details open>
      <summary>試合履歴（<span id="historyCount">0</span>）</summary>
      <div id="historyList" style="margin-top:10px;display:grid;gap:8px"></div>
    </details>
  </section>

  <section class="card" style="margin-top:10px">
    <h3>このアプリのかんたんな使い方</h3>
    <ol style="margin:6px 0 10px;padding-left:1.2em">
      <li>上のフォームで<b>名前</b>と<b>希望ロール</b>を入れて〔追加〕</li>
      <li>参加者が<b>5人以上</b>になったら〔<b>自動選定（確定）</b>〕でサバ4＋ハン1を確定</li>
      <li>参加者が<b>10人以上</b>なら「<b>2試合同時</b>」で2枠確定（被りなし）</li>
      <li>「<b>主催者を必ず参加させる</b>」をON＋主催者名を選ぶと、毎回主催者を含めて抽選（2試合同時時はA側）</li>
      <li>微調整は「<b>手動修正</b>」ON → 名前/希望変更、回数<b>＋/−</b>、<b>手動試合追加</b></li>
      <li>抜けた人は行末の<b>削除</b>（履歴からも除去して再計算）／左端チェックで<b>一括削除</b></li>
      <li>配信用は「<b>配信用オーバーレイ</b>」または OBS で <code>?overlay=1&amp;transparent=1</code> を付けたURL</li>
      <li><b>通知を有効化</b>で確定ごとにスマホへ最新メンバー通知（iOSはPWAのみ対応）</li>
      <li>ライト/ダークは🌓で「Auto→Light→Dark」切替。データはブラウザ保存（CSV出力でバックアップ）</li>
    </ol>
    <p class="muted" style="margin:0">※ iOSのSafariタブは通知不可。ホーム画面に追加（PWA）で利用可能。</p>
  </section>

  <p class="muted" style="margin-top:10px">
    © <span id="year"></span> IdentityV Queue Balancer — クライアントローカル保存<br>
    制作：<a href="https://x.com/tomoyann999" target="_blank" rel="noopener noreferrer">X（@tomoyann999）</a> /
    <a href="https://www.tiktok.com/@tomoyann999" target="_blank" rel="noopener noreferrer">TikTok（@tomoyann999）</a>
  </p>
</div>

<!-- 下部固定操作バー（スマホ用） -->
<div class="dock" role="toolbar" aria-label="クイック操作">
  <button class="btn btn-primary" onclick="pickNext()">次の試合</button>
  <label class="row" style="gap:6px"><input id="dualToggleDock" type="checkbox" onchange="toggleDualDock()"> <span>2試合同時</span></label>
  <button class="btn btn-danger" onclick="bulkDeleteSelected()">一括削除</button>
  <button id="themeBtnDock" class="btn theme-btn" onclick="cycleTheme()" aria-label="テーマ切替">🌓 Auto</button>
  <span id="miniLineup" class="muted"></span>
</div>

<!-- iOSガイド（モーダル） -->
<dialog id="iosGuide">
  <h3 style="margin:0 0 8px">iOSで通知を使う手順</h3>
  <ol style="margin:0 0 10px;padding-left:1.2em">
    <li>Safariでこのページを開く</li>
    <li>共有ボタン → <b>ホーム画面に追加</b> を選択</li>
    <li>ホームから追加したアプリを開く → <b>通知を有効化</b> を押して「許可」</li>
  </ol>
  <p class="muted" style="margin:0 0 8px">※ iOSは「Safariタブ」では通知不可で、ホーム画面のWebアプリ（PWA）のみ対応です。</p>
  <div class="row" style="justify-content:flex-end"><button class="btn" onclick="document.getElementById('iosGuide').close()">閉じる</button></div>
</dialog>

<script src="app.js"></script>
</body>
</html>
